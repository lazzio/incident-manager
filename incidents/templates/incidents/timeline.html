{% extends 'base.html' %}
{% load static %}

{% block title %}Chronologie des Incidents{% endblock %}

{% block extra_head %}
<style>
  /* Animations et transitions */
  .fade-in {
    animation: fadeIn 0.7s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .timeline-item {
    transition: all 0.3s ease;
    animation: slideIn 0.5s ease-out forwards;
    opacity: 0;
    transform: translateX(-20px);
  }
  
  @keyframes slideIn {
    to { opacity: 1; transform: translateX(0); }
  }
  
  /* Animation delays - using predefined classes instead */
  .delay-1 { animation-delay: 0.1s; }
  .delay-2 { animation-delay: 0.2s; }
  .delay-3 { animation-delay: 0.3s; }
  .delay-4 { animation-delay: 0.4s; }
  .delay-5 { animation-delay: 0.5s; }
  .delay-6 { animation-delay: 0.6s; }
  .delay-7 { animation-delay: 0.7s; }
  .delay-8 { animation-delay: 0.8s; }
  .delay-9 { animation-delay: 0.9s; }
  .delay-10 { animation-delay: 1s; }
  
  /* Timeline styling */
  .timeline-container {
    position: relative;
    padding-left: 2rem;
  }
  
  .timeline-container::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0.75rem;
    width: 2px;
    background: linear-gradient(to bottom, 
      rgba(var(--primary), 0.5) 0%, 
      rgba(var(--primary), 0.5) 100%);
  }
  
  .timeline-dot {
    position: absolute;
    left: 0;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    transform: translateX(-12px);
    z-index: 10;
    transition: all 0.3s ease;
  }
  
  .timeline-node {
    position: relative;
    margin-bottom: 2.5rem;
  }
  
  .timeline-node:hover .timeline-dot {
    transform: translateX(-12px) scale(1.3);
    box-shadow: 0 0 0 4px rgba(var(--primary), 0.2);
  }
  
  .timeline-card {
    transition: all 0.3s ease;
  }
  
  .timeline-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
  }
  
  .severity-indicator {
    position: absolute;
    left: 0;
    top: 0;
    width: 4px;
    height: 100%;
    border-radius: 2px;
  }
  
  .timeline-connector {
    position: absolute;
    left: 0.75rem;
    top: 24px;
    bottom: -48px;
    width: 2px;
    background: linear-gradient(to bottom, 
      rgba(var(--primary), 0.7),
      rgba(var(--primary), 0.3));
    transform: translateX(-1px);
  }
  
  .timeline-node:last-child .timeline-connector {
    display: none;
  }
  
  .timeline-date {
    position: sticky;
    top: 1rem;
    background-color: hsla(var(--b1)/0.8);
    backdrop-filter: blur(8px);
    z-index: 2;
    border-radius: 0.5rem;
    margin-left: -1rem;
    margin-bottom: 1.5rem;
    padding: 0.5rem 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    font-weight: 600;
  }
  
  /* Timeline zoom controls */
  .zoom-controls {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 50;
    display: flex;
    gap: 0.5rem;
    flex-direction: column;
  }
  
  /* Height on scroll animations */
  .scroll-trigger {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease;
  }
  
  .scroll-visible {
    opacity: 1;
    transform: translateY(0);
  }
  
  .period-nav {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 0.25rem;
    padding: 0.25rem;
    margin-bottom: 1rem;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  
  .period-nav::-webkit-scrollbar {
    display: none;
  }
  
  .period-btn {
    white-space: nowrap;
    transition: all 0.3s ease;
  }
  
  .period-btn.active {
    background-color: hsl(var(--p));
    color: hsl(var(--pc));
  }

  /* Grouping by month */
  .month-group {
    position: relative;
  }
  
  .month-header {
    position: sticky;
    top: 0;
    z-index: 20;
    padding: 0.5rem 0;
    margin-bottom: 1rem;
    color: hsl(var(--bc));
    font-weight: bold;
    font-size: 1.25rem;
  }
  
  /* Day marker */
  .day-marker {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    margin-left: -1rem;
    opacity: 0.7;
  }
  
  .day-marker::before {
    content: '';
    flex: 0 0 10px;
    height: 1px;
    background-color: hsl(var(--bc) / 0.2);
    margin-right: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
  <!-- En-tête avec navigation de période -->
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
    <div>
      <div class="text-sm breadcrumbs">
        <ul>
          <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
          <li>Chronologie</li>
          <li>{{ selected_year }}</li>
        </ul>
      </div>
      <h1 class="text-3xl font-bold">Chronologie des Incidents</h1>
      <p class="text-muted-foreground mt-1">
        Visualisez les incidents chronologiquement
      </p>
    </div>
    
    <div class="flex flex-wrap gap-2">
      <div class="dropdown dropdown-end">
        <button class="btn btn-outline">
          <span class="material-symbols-rounded w-5 h-5 mr-2">calendar_month</span>
          {{ selected_year }}
          <span class="material-symbols-rounded w-4 h-4 ml-2">arrow_downward</span>
        </button>
        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 max-h-60 overflow-y-auto">
          {% for year in available_years %}
          <li><a href="?year={{ year }}" class="{% if year == selected_year %}active{% endif %}">{{ year }}</a></li>
          {% empty %}
          <li><a class="disabled">Aucune donnée disponible</a></li>
          {% endfor %}
        </ul>
      </div>
      
      <a href="{% url 'incident_create' %}" class="btn btn-primary">
        <span class="material-symbols-rounded w-5 h-5 mr-2">add_circle</span>
        Nouvel incident
      </a>
    </div>
  </div>
  
  <!-- Filtres et contrôles -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4">
      <h3 class="font-semibold flex items-center">
        <span class="material-symbols-rounded w-5 h-5 mr-2">add_circle</span>
        Filtres et période
      </h3>
      
      <!-- Navigation rapide par mois -->
      <div class="period-nav scrollbar-hide">
        {% for month in months %}
        <a href="#month-{{ month.number }}" class="period-btn btn btn-sm {% if month.current %}active{% endif %}">
          {{ month.name }}
        </a>
        {% endfor %}
      </div>
      
      <div class="flex flex-wrap gap-3 justify-between items-center">
        <!-- Filtres -->
        <div class="flex flex-wrap gap-2">
          <div class="dropdown">
            <label tabindex="0" class="btn btn-sm btn-outline">
              <span class="material-symbols-rounded w-4 h-4 mr-2">trending_up</span>
              Sévérité
            </label>
            <div tabindex="0" class="dropdown-content z-[1] card card-compact w-64 p-0 shadow-lg bg-base-100 mt-1">
              <div class="card-body p-3">
                <div class="form-control">
                  {% for severity in severities %}
                  <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" class="checkbox checkbox-sm" checked>
                    <span>{{ severity }}</span>
                  </label>
                  {% endfor %}
                </div>
                <div class="card-actions mt-2">
                  <button class="btn btn-sm btn-primary btn-block">Appliquer</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="dropdown">
            <label tabindex="0" class="btn btn-sm btn-outline">
              <span class="material-symbols-rounded w-4 h-4 mr-2">label</span>
              Statut
            </label>
            <div tabindex="0" class="dropdown-content z-[1] card card-compact w-64 p-0 shadow-lg bg-base-100 mt-1">
              <div class="card-body p-3">
                <div class="form-control">
                  {% for status in statuses %}
                  <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" class="checkbox checkbox-sm" checked>
                    <span>{{ status }}</span>
                  </label>
                  {% endfor %}
                </div>
                <div class="card-actions mt-2">
                  <button class="btn btn-sm btn-primary btn-block">Appliquer</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Vue -->
        <div class="join">
          <button class="join-item btn btn-sm active" data-view="detailed">
            <span class="material-symbols-rounded w-4 h-4">open_in_new</span>
          </button>
          <button class="join-item btn btn-sm" data-view="compact">
            <span class="material-symbols-rounded w-4 h-4">more_vert</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Timeline -->
  <div class="relative">
    <!-- Timeline content -->
    {% if incidents %}
    <div id="timeline-content" class="timeline-container fade-in">
      {% regroup incidents by start_date|date:"F Y" as incidents_by_month %}
      
      {% for month_group in incidents_by_month %}
      <div id="month-{{ forloop.counter }}" class="month-group">
        <h2 class="month-header">{{ month_group.grouper }}</h2>
        
        {% regroup month_group.list by start_date|date:"d F Y" as incidents_by_day %}
        
        {% for day_group in incidents_by_day %}
        <div class="day-marker">
          <span class="text-sm">{{ day_group.grouper }}</span>
        </div>
        
        {% for incident in day_group.list %}
        <div class="timeline-node timeline-item delay-{% if forloop.counter <= 10 %}{{ forloop.counter }}{% else %}10{% endif %}">
          <!-- Dot marker with severity color -->
          <div class="timeline-dot flex items-center justify-center 
            {% if incident.severity == 'CRITICAL' %}bg-error text-error-content
            {% elif incident.severity == 'HIGH' %}bg-warning text-warning-content
            {% elif incident.severity == 'MEDIUM' %}bg-info text-info-content
            {% else %}bg-base-300 text-base-content{% endif %}">
            <span class="material-symbols-rounded w-3.5 h-3.5 mr-2.5 mb-2">timer</span>
          </div>
          
          <!-- Connector line -->
          <div class="timeline-connector"></div>
          
          <!-- Incident card -->
          <div class="timeline-card card bg-base-100 shadow-lg ml-4">
            <div class="card-body p-5 relative">
              <!-- Severity indicator -->
              <div class="severity-indicator 
                {% if incident.severity == 'CRITICAL' %}bg-error
                {% elif incident.severity == 'HIGH' %}bg-warning
                {% elif incident.severity == 'MEDIUM' %}bg-info
                {% else %}bg-base-300{% endif %}">
              </div>
              
              <!-- Time -->
              <div class="text-sm text-muted-foreground flex items-center mb-1">
                <span class="material-symbols-rounded w-3.5 h-3.5 flex-shrink-0 mr-4 mb-2">watch_vibration</span>
                <span> {{ incident.start_date|date:"H:i" }}</span>
                
                {% if incident.end_date %}
                <span class="mx-1">-</span>
                <span class="material-symbols-rounded w-3.5 h-3.5 flex-shrink-0 mr-3 mb-2">timelapse</span>
                <span> {{ incident.duration }}</span>
                {% endif %}
              </div>
              
              <!-- Titre avec statut -->
              <h3 class="card-title text-lg flex justify-between">
                <div class="flex items-center gap-2">
                  {{ incident.title }}
                </div>
                <div class="flex gap-2">
                  {% if incident.status == 'new' %}
                  <div class="badge badge-info gap-1">
                    <img src="{% static 'img/iconsax/All/linear/document-text.svg' %}" class="w-3 h-3" alt="New">
                    Nouveau
                  </div>
                  {% elif incident.status == 'in_progress' %}
                  <div class="badge badge-warning gap-1">
                    <img src="{% static 'img/iconsax/All/linear/timer-pause.svg' %}" class="w-3 h-3" alt="In Progress">
                    En cours
                  </div>
                  {% elif incident.status == 'resolved' %}
                  <div class="badge badge-success gap-1">
                    <img src="{% static 'img/iconsax/All/linear/tick-circle.svg' %}" class="w-3 h-3" alt="Resolved">
                    Résolu
                  </div>
                  {% endif %}
                  
                  <div class="badge 
                    {% if incident.severity == 'CRITICAL' %}badge-error
                    {% elif incident.severity == 'HIGH' %}badge-warning
                    {% elif incident.severity == 'MEDIUM' %}badge-info
                    {% else %}badge-ghost{% endif %} gap-1">
                    <img src="{% static 'img/iconsax/All/linear/danger.svg' %}" class="w-3 h-3" alt="Severity">
                    {{ incident.get_severity_display }}
                  </div>
                </div>
              </h3>
              
              <!-- Description -->
              <div class="mt-2 text-sm line-clamp-3">
                {{ incident.details|truncatewords:30 }}
              </div>
              
              <!-- Users and actions -->
              <div class="card-actions justify-between items-center mt-4">
                <div class="flex items-center gap-2">
                  <div class="avatar-group -space-x-2">
                    {% if incident.created_by %}
                    <div class="avatar placeholder" data-tooltip-target="tooltip-creator" title="Créé par: {{ incident.created_by.get_full_name|default:incident.created_by.username }}">
                      <div class="bg-neutral text-neutral-content w-8 rounded-full">
                        <span>{{ incident.created_by.username|slice:":1"|upper }}</span>
                      </div>
                    </div>
                    {% endif %}
                    
                    {% if incident.assigned_to %}
                    <div class="avatar placeholder" data-tooltip-target="tooltip-assignee" title="Assigné à: {{ incident.assigned_to.get_full_name|default:incident.assigned_to.username }}">
                      <div class="bg-primary text-primary-content w-8 rounded-full">
                        <span>{{ incident.assigned_to.username|slice:":1"|upper }}</span>
                      </div>
                    </div>
                    {% endif %}
                  </div>
                  
                  {% if incident.comments.count %}
                  <div class="badge badge-ghost gap-1">
                    <img src="{% static 'img/iconsax/All/linear/message.svg' %}" class="w-3.5 h-3.5" alt="Comments">
                    {{ incident.comments.count }}
                  </div>
                  {% endif %}
                  
                  {% if incident.files.count %}
                  <div class="badge badge-ghost gap-1">
                    <img src="{% static 'img/iconsax/All/linear/document.svg' %}" class="w-3.5 h-3.5" alt="Files">
                    {{ incident.files.count }}
                  </div>
                  {% endif %}
                </div>
                
                <div class="flex gap-2">
                  <a href="{% url 'incident_detail' incident.id %}" class="btn btn-sm btn-ghost">
                    <img src="{% static 'img/iconsax/All/linear/eye.svg' %}" class="w-4 h-4 mr-1" alt="View">
                    Détails
                  </a>
                  <div class="dropdown dropdown-left dropdown-hover">
                    <div tabindex="0" class="btn btn-sm btn-ghost">
                      <img src="{% static 'img/iconsax/All/linear/more.svg' %}" class="w-4 h-4" alt="More">
                    </div>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                      <li>
                        <a href="{% url 'incident_update' incident.id %}">
                          <img src="{% static 'img/iconsax/All/linear/edit-2.svg' %}" class="w-4 h-4" alt="Edit">
                          Modifier
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'incident_detail' incident.id %}#comments">
                          <img src="{% static 'img/iconsax/All/linear/message-text.svg' %}" class="w-4 h-4" alt="Comment">
                          Commenter
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        {% endfor %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="flex flex-col items-center justify-center py-20">
      <img src="{% static 'img/iconsax/All/bulk/calendar-tick.svg' %}" class="w-24 h-24 text-base-content/20 mb-4" alt="No incidents">
      <h3 class="text-2xl font-bold">Aucun incident pour {{ selected_year }}</h3>
      <p class="text-muted-foreground mb-4">Aucun incident n'a été enregistré pour cette période.</p>
      <div class="flex gap-3">
        <button class="btn btn-outline btn-sm" onclick="window.history.back()">
          <img src="{% static 'img/iconsax/All/linear/arrow-left.svg' %}" class="w-4 h-4 mr-2" alt="Back">
          Retour
        </button>
        <a href="{% url 'incident_create' %}" class="btn btn-primary btn-sm">
          <img src="{% static 'img/iconsax/All/linear/add.svg' %}" class="w-4 h-4 mr-2" alt="Add">
          Créer un incident
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Scroll animation
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('scroll-visible');
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1
    });
    
    document.querySelectorAll('.scroll-trigger').forEach(el => {
      observer.observe(el);
    });
    
    // Smooth scroll to month
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        
        if (targetElement) {
          window.scrollTo({
            top: targetElement.offsetTop - 100,
            behavior: 'smooth'
          });
          
          // Update active state
          document.querySelectorAll('.period-btn').forEach(b => {
            b.classList.remove('active');
          });
          this.classList.add('active');
        }
      });
    });
    
    // View switching
    const viewButtons = document.querySelectorAll('[data-view]');
    viewButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const view = this.getAttribute('data-view');
        const timeline = document.getElementById('timeline-content');
        
        // Update active state
        viewButtons.forEach(b => {
          b.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update view
        if (view === 'compact') {
          timeline.classList.add('compact-view');
        } else {
          timeline.classList.remove('compact-view');
        }
      });
    });    
  });
</script>
{% endblock %}