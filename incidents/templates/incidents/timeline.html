{% extends 'base.html' %}
{% load static %}

{% block title %}Incident Timeline{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- En-tÃªte avec breadcrumbs -->
    <div>
        <div class="text-sm breadcrumbs">
            <ul>
                <li><a href="{% url 'dashboard' %}">Home</a></li>
                <li>Timeline</li>
            </ul>
        </div>
        
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h1 class="text-3xl font-bold">Incident Timeline</h1>
            <div class="flex gap-2">
                <a href="{% url 'incident_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    New incident
                </a>
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        {{ selected_year }}
                        <i class="fas fa-caret-down ml-2"></i>
                    </label>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        {% for year in available_years %}
                        <li><a href="?year={{ year }}" {% if year == selected_year %}class="active"{% endif %}>{{ year }}</a></li>
                        {% empty %}
                        <li><a class="disabled">No data available</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Timeline -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-clock mr-2"></i>
                Timeline for {{ selected_year }}
            </h2>
            
            {% if incidents %}
            <ul class="timeline timeline-snap-icon max-md:timeline-compact timeline-vertical">
                {% for incident in incidents %}
                <li>
                    <div class="timeline-middle">
                        {% if incident.severity == 'LOW' %}
                        <div class="avatar placeholder">
                            <div class="bg-neutral text-neutral-content w-8 rounded-full">
                                <i class="fas fa-exclamation"></i>
                            </div>
                        </div>
                        {% elif incident.severity == 'MEDIUM' %}
                        <div class="avatar placeholder">
                            <div class="bg-info text-info-content w-8 rounded-full">
                                <i class="fas fa-exclamation"></i>
                            </div>
                        </div>
                        {% elif incident.severity == 'HIGH' %}
                        <div class="avatar placeholder">
                            <div class="bg-warning text-warning-content w-8 rounded-full">
                                <i class="fas fa-exclamation"></i>
                            </div>
                        </div>
                        {% elif incident.severity == 'CRITICAL' %}
                        <div class="avatar placeholder">
                            <div class="bg-error text-error-content w-8 rounded-full">
                                <i class="fas fa-exclamation"></i>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="timeline-start md:text-end mb-10">
                        <time class="font-mono">{{ incident.start_date|date:"j M Y, H:i" }}</time>
                        <div class="text-lg font-black">{{ incident.title }}</div>
                        <div class="text-sm">
                            {% if incident.status == 'new' %}
                                <span class="badge badge-info">New</span>
                            {% elif incident.status == 'in_progress' %}
                                <span class="badge badge-warning">In Progress</span>
                            {% elif incident.status == 'resolved' %}
                                <span class="badge badge-success">Resolved</span>
                            {% endif %}
                            
                            {% if incident.end_date %}
                            <span class="ml-2">Duration: {{ incident.duration }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <hr class="{% if incident.severity == 'LOW' %}bg-neutral{% elif incident.severity == 'MEDIUM' %}bg-info{% elif incident.severity == 'HIGH' %}bg-warning{% elif incident.severity == 'CRITICAL' %}bg-error{% endif %}"/>
                    <div class="timeline-end mb-10">
                        <div class="text-sm mb-2">{{ incident.details|truncatechars:150 }}</div>
                        <div class="card-actions">
                            <a href="{% url 'incident_detail' incident.id %}" class="btn btn-sm btn-outline">
                                View details
                            </a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="py-10 text-center">
                <div class="flex flex-col items-center">
                    <i class="fas fa-calendar-xmark text-4xl text-base-content/30 mb-4"></i>
                    <p class="text-base-content/50">No incidents found for {{ selected_year }}.</p>
                    <a href="{% url 'incident_create' %}" class="btn btn-primary btn-sm mt-4">Create one now</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}