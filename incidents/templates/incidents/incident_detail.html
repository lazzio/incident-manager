{% extends 'base.html' %}
{% load static %}

{% block title %}Incident #{{ incident.id }} - {{ incident.title }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- En-tête avec breadcrumbs -->
    <div>
        <div class="text-sm breadcrumbs">
            <ul>
                <li><a href="{% url 'dashboard' %}">Home</a></li>
                <li><a href="{% url 'incident_list' %}">Incidents</a></li>
                <li>Incident #{{ incident.id }}</li>
            </ul>
        </div>
        
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h1 class="text-3xl font-bold">
                {{ incident.title }}
            </h1>
            <div class="flex gap-2">
                <a href="{% url 'incident_update' incident.id %}" class="btn btn-primary">
                    <span class="material-symbols-rounded mr-2">
                        edit_note
                    </span>
                    Edit
                </a>
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-ghost btn-circle">
                        <span class="material-symbols-rounded">
                            more_vert
                        </span>
                    </label>
                    <ul tabindex="0" class="menu dropdown-content z-[1] p-2 shadow bg-base-100 rounded-box w-52 mt-4">
                        <li><a href="#comments"><span class="material-symbols-rounded mr-2">comment</span> Comments</a></li>
                        <li><a href="#files"><span class="material-symbols-rounded mr-2">attach_file</span> Files</a></li>
                        <li><a href="{% url 'incident_delete' incident.id %}"><span class="material-symbols-rounded mr-2">delete</span> Delete</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Info badge -->
    <div class="flex flex-wrap gap-2">
        {% if incident.status == 'new' %}
            <div class="badge badge-lg badge-info gap-1">
                <span class="material-symbols-rounded text-xs scale-75">cake</span> New
            </div>
        {% elif incident.status == 'in_progress' %}
            <div class="badge badge-lg badge-warning gap-1">
                <span class="material-symbols-rounded text-xs scale-75">progress_activity</span> In Progress
            </div>
        {% elif incident.status == 'resolved' %}
            <div class="badge badge-lg badge-success gap-1">
                <span class="material-symbols-rounded text-xs scale-75">check</span> Resolved
            </div>
        {% endif %}
        
        {% if incident.severity == 'LOW' %}
            <div class="badge badge-lg badge-ghost gap-1">
                <span class="material-symbols-rounded text-xs scale-75">south</span> Low Severity
            </div>
        {% elif incident.severity == 'MEDIUM' %}
            <div class="badge badge-lg badge-info gap-1">
                <span class="material-symbols-rounded text-xs scale-75">remove</span> Medium Severity
            </div>
        {% elif incident.severity == 'HIGH' %}
            <div class="badge badge-lg badge-warning gap-1">
                <span class="material-symbols-rounded text-xs scale-75">north</span> High Severity
            </div>
        {% elif incident.severity == 'CRITICAL' %}
            <div class="badge badge-lg badge-error gap-1">
                <span class="material-symbols-rounded text-xs scale-75">skull</span> Critical Severity
            </div>
        {% endif %}
        
        <div class="badge badge-lg badge-outline gap-1">
            <span class="material-symbols-rounded text-xs scale-75">today</span> {{ incident.start_date|date:"d/m/Y H:i" }}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Colonne principale -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Description -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">description</span>
                        Description
                    </h2>
                    <div class="bg-base-200 rounded-lg p-4 whitespace-pre-wrap">
                        {{ incident.details }}
                    </div>
                </div>
            </div>
            
            <!-- Resolution Process -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">construction</span>
                        Resolution Process
                    </h2>
                    <div class="bg-base-200 rounded-lg p-4 whitespace-pre-wrap">
                        {{ incident.resolution_process }}
                    </div>
                </div>
            </div>
            
            <!-- Impact -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">balance</span>
                        Impact
                    </h2>
                    <div class="bg-base-200 rounded-lg p-4 whitespace-pre-wrap">
                        {{ incident.impact }}
                    </div>
                </div>
            </div>
            
            <!-- Files -->
            <div id="files" class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">attach_file</span>
                        Files
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for file in incident_files %}
                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                {% if file.is_image %}
                                <figure class="h-32 flex items-center justify-center bg-base-300 rounded-md mb-3 overflow-hidden cursor-pointer"
                                       onclick="openImageModal('{{ file.file.url }}', '{{ file.filename }}')">
                                    <img src="{{ file.file.url }}" alt="{{ file.filename }}" 
                                         class="h-full w-full object-contain">
                                </figure>
                                {% else %}
                                <figure class="h-32 flex items-center justify-center bg-base-300 rounded-md mb-3">
                                    <i class="fas {{ file.file_icon }} fa-3x opacity-50"></i>
                                </figure>
                                {% endif %}
                                
                                <h3 class="card-title text-sm line-clamp-2" title="{{ file.filename }}">
                                    {{ file.filename }}
                                </h3>
                                
                                <div class="text-xs opacity-70 flex justify-between">
                                    <span>{{ file.uploaded_at|date:"d/m/Y H:i" }}</span>
                                    <span>{{ file.uploaded_by.username }}</span>
                                </div>
                                
                                <div class="card-actions justify-end mt-3">
                                    <a href="{{ file.file.url }}" target="_blank" class="btn btn-xs btn-primary">
                                        <span class="material-symbols-rounded mr-1">download</span>
                                        Download
                                    </a>
                                    {% if file.is_image %}
                                    <button onclick="openImageModal('{{ file.file.url }}', '{{ file.filename }}')"
                                            class="btn btn-xs btn-outline">
                                            <span class="material-symbols-rounded mr-1">visibility</span>
                                        Preview
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-span-full py-8 flex flex-col items-center">
                            <span class="material-symbols-rounded opacity-30 mb-4" style="font-size: 48px;">upload_file</span>
                            <p class="opacity-50">No files attached to this incident.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Comments -->
            <div id="comments" class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">comment</span>
                        Comments
                        <span class="badge">{{ comments|length }}</span>
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        {% for comment in comments %}
                        <div class="chat {% if comment.created_by == request.user %}chat-end{% else %}chat-start{% endif %}">
                            <div class="chat-image avatar placeholder">
                                <div class="bg-neutral-focus text-neutral-content rounded-full w-10">
                                    <span>{{ comment.created_by.username|slice:":1"|upper }}</span>
                                </div>
                            </div>
                            <div class="chat-header">
                                {{ comment.created_by.get_full_name|default:comment.created_by.username }}
                                <time class="text-xs opacity-50">{{ comment.created_at|date:"d/m/Y H:i" }}</time>
                            </div>
                            <div class="chat-bubble {% if comment.created_by == request.user %}chat-bubble-primary{% endif %}">{{ comment.text }}</div>
                        </div>
                        {% empty %}
                        <div class="flex flex-col items-center py-8">
                            <span class="material-symbols-rounded opacity-30 mb-4" style="font-size: 48px;">comment</span>
                            <p class="opacity-50">No comments yet. Be the first to comment on this incident.</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Formulaire de commentaire -->
                    <div class="border-t border-base-300 pt-4">
                        <h3 class="font-medium mb-3">Add a comment</h3>
                        <form method="post" action="{% url 'add_comment' incident.id %}" class="space-y-4">
                            {% csrf_token %}
                            <div class="form-control">
                                <textarea name="text" rows="3" class="textarea textarea-bordered w-full" 
                                          placeholder="Write your comment here..." required></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="btn btn-primary">
                                    <span class="material-symbols-rounded mr-2">send</span>
                                    Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Colonne latérale -->
        <div class="space-y-6">
            <!-- Info générales -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">info</span>
                        General Information
                    </h2>
                    
                    <div class="space-y-4 mt-2">
                        <div>
                            <div class="text-sm font-medium opacity-70 mb-1">Created by:</div>
                            <div class="flex items-center">
                                <div class="avatar placeholder mr-2">
                                    <div class="bg-neutral-focus text-neutral-content rounded-full w-8">
                                        <span>{{ incident.created_by.username|slice:":1"|upper }}</span>
                                    </div>
                                </div>
                                <span>{{ incident.created_by.get_full_name|default:incident.created_by.username }}</span>
                            </div>
                        </div>
                        
                        <div>
                            <div class="text-sm font-medium opacity-70 mb-1">Assigned to:</div>
                            <div>
                                {% if incident.assigned_to %}
                                <div class="flex items-center">
                                    <div class="avatar placeholder mr-2">
                                        <div class="bg-primary-focus text-primary-content rounded-full w-8">
                                            <span>{{ incident.assigned_to.username|slice:":1"|upper }}</span>
                                        </div>
                                    </div>
                                    <span>{{ incident.assigned_to.get_full_name|default:incident.assigned_to.username }}</span>
                                </div>
                                {% else %}
                                <span class="opacity-50">Not assigned</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <div class="text-sm font-medium opacity-70 mb-1">Category:</div>
                            <div>{{ incident.get_category_display }}</div>
                        </div>
                        
                        <div>
                            <div class="text-sm font-medium opacity-70 mb-1">Duration:</div>
                            <div>
                                {% if incident.duration %}
                                {{ incident.duration }}
                                {% elif incident.start_date and incident.end_date %}
                                {{ incident.start_date|timesince:incident.end_date }}
                                {% elif incident.start_date %}
                                <span class="opacity-50">Ongoing</span>
                                {% else %}
                                <span class="opacity-50">Unknown</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <div class="text-sm font-medium opacity-70 mb-1">Created at:</div>
                            <div>{{ incident.created_at|date:"d/m/Y H:i" }}</div>
                        </div>
                        
                        <div>
                            <div class="text-sm font-medium opacity-70 mb-1">Last updated:</div>
                            <div>{{ incident.updated_at|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiques -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">pie_chart</span>
                        Statistics
                    </h2>
                    
                    <div class="stats stats-vertical shadow w-full">
                        <div class="stat">
                            <div class="stat-title">Files</div>
                            <div class="stat-value">{{ incident_files|length }}</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-title">Comments</div>
                            <div class="stat-value">{{ comments|length }}</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-title">Updates</div>
                            <div class="stat-value">{{ updates|length }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded mr-1">bolt</span>
                        Actions
                    </h2>
                    
                    <div class="space-y-2 mt-2">
                        <a href="{% url 'incident_update' incident.id %}" class="btn btn-primary w-full">
                            <span class="material-symbols-rounded mr-1">edit_note</span>
                            Edit incident
                        </a>
                        <a href="{% url 'incident_delete' incident.id %}" class="btn btn-error w-full">
                            <span class="material-symbols-rounded mr-1">delete</span>
                            Delete incident
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour prévisualiser les images -->
<div id="imageModal" class="fixed inset-0 bg-black/0 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-300 ease-in-out">
    <div id="modalContainer" class="bg-base-100 rounded-lg shadow-lg max-w-4xl w-full mx-4 overflow-hidden transform scale-95 transition-all duration-300 ease-in-out">
        <div class="flex justify-between items-center p-4 border-b border-base-300">
            <h3 id="modalTitle" class="text-xl font-semibold truncate">Aperçu du fichier</h3>
            <button id="closeModal" class="btn btn-sm btn-circle btn-ghost">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-4">
            <div id="modalContent" class="flex items-center justify-center">
                <!-- Le contenu de l'image sera injecté ici -->
            </div>
        </div>
        <div class="flex justify-end items-center p-4 border-t border-base-300 gap-2">
            <a id="downloadLink" href="#" class="btn btn-primary">
                <i class="fas fa-download mr-2"></i>
                Download
            </a>
            <button id="closeModalBtn" class="btn btn-ghost">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    function openImageModal(imageUrl, filename) {
        // Récupérer les éléments de la modale
        const modal = document.getElementById('imageModal');
        const modalContainer = document.getElementById('modalContainer');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const downloadLink = document.getElementById('downloadLink');
        
        // Mettre à jour le contenu de la modale
        modalTitle.textContent = filename;
        modalContent.innerHTML = `<img src="${imageUrl}" alt="${filename}" class="max-h-[70vh] max-w-full object-contain">`;
        downloadLink.href = imageUrl;
        
        // Afficher la modale avec animation
        modal.classList.remove('pointer-events-none');
        
        // Forcer un reflow pour que les transitions fonctionnent
        void modal.offsetWidth;
        
        // Appliquer l'animation
        modal.classList.add('opacity-100');
        modal.classList.add('bg-black/50');
        modalContainer.classList.remove('scale-95');
        modalContainer.classList.add('scale-100');
        
        // Empêcher le défilement de la page
        document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
        const modal = document.getElementById('imageModal');
        const modalContainer = document.getElementById('modalContainer');
        
        // Masquer la modale avec animation
        modal.classList.remove('opacity-100');
        modal.classList.remove('bg-black/50');
        modal.classList.add('opacity-0');
        modalContainer.classList.remove('scale-100');
        modalContainer.classList.add('scale-95');
        
        // Attendre la fin de l'animation avant de cacher complètement
        setTimeout(() => {
            modal.classList.add('pointer-events-none');
            document.body.style.overflow = '';
        }, 300);
    }
    
    // Fermer la modale en cliquant sur le bouton de fermeture
    document.getElementById('closeModal').addEventListener('click', closeModal);
    
    // Fermer la modale en cliquant sur le bouton Fermer
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    
    // Fermer la modale en cliquant à l'extérieur de celle-ci
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Fermer la modale avec la touche Échap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('imageModal').classList.contains('pointer-events-none')) {
            closeModal();
        }
    });
</script>

{% endblock %}

{% block extra_js %}
<script>
  function copyShareUrl() {
    const copyText = document.getElementById("shareUrl");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
    
    const copyBtn = document.getElementById("copyBtn");
    const originalImg = copyBtn.innerHTML;
    
    // Change button to confirm copy
    copyBtn.innerHTML = `<img src="{% static 'img/iconsax/All/linear/tick-circle.svg' %}" class="w-4 h-4" alt="Copied">`;
    
    // Show toast notification
    toast.success("Lien copié dans le presse-papier !");
    
    // Reset button after 2 seconds
    setTimeout(() => {
      copyBtn.innerHTML = originalImg;
    }, 2000);
  }
  
  // Handle comment editing and deletion
  document.querySelectorAll('.edit-comment').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const commentId = this.getAttribute('data-id');
      
      // Find the comment container
      const commentContainer = this.closest('.bg-base-200');
      const commentTextElement = commentContainer.querySelector('.prose');
      const originalText = commentTextElement.textContent.trim();
      
      // Create edit form
      const editForm = document.createElement('div');
      editForm.className = 'mt-3';
      editForm.innerHTML = `
        <textarea class="textarea textarea-bordered w-full" rows="3">${originalText}</textarea>
        <div class="flex justify-end gap-2 mt-2">
          <button class="btn btn-sm btn-ghost cancel-edit">Annuler</button>
          <button class="btn btn-sm btn-primary save-edit" data-id="${commentId}">
            <img src="{% static 'img/iconsax/All/linear/save-2.svg' %}" class="w-4 h-4 mr-1" alt="Save">
            Enregistrer
          </button>
        </div>
      `;
      
      // Replace comment text with edit form
      commentTextElement.style.display = 'none';
      commentContainer.appendChild(editForm);
      
      // Handle cancel button
      editForm.querySelector('.cancel-edit').addEventListener('click', function() {
        commentTextElement.style.display = '';
        editForm.remove();
      });
      
      // Handle save button
      editForm.querySelector('.save-edit').addEventListener('click', function() {
        const newText = editForm.querySelector('textarea').value.trim();
        
        if (newText !== originalText) {
          // Show loading state
          this.classList.add('loading');
          this.disabled = true;
          
          // Send update to server
          fetch(`/incidents/comment/${commentId}/update/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: `text=${encodeURIComponent(newText)}`
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update comment text
              commentTextElement.innerHTML = newText.replace(/\n/g, '<br>');
              commentTextElement.style.display = '';
              editForm.remove();
              
              toast.success('Commentaire mis à jour avec succès');
            } else {
              toast.error('Erreur lors de la mise à jour du commentaire');
            }
          })
          .catch(error => {
            toast.error('Une erreur est survenue');
            console.error('Error:', error);
          });
        } else {
          // No changes, just cancel
          commentTextElement.style.display = '';
          editForm.remove();
        }
      });
    });
  });
  
  document.querySelectorAll('.delete-comment').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const commentId = this.getAttribute('data-id');
      
      if (confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?')) {
        // Send delete request to server
        fetch(`/incidents/comment/${commentId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove comment from DOM
            this.closest('.bg-base-200').remove();
            toast.success('Commentaire supprimé avec succès');
          } else {
            toast.error('Erreur lors de la suppression du commentaire');
          }
        })
        .catch(error => {
          toast.error('Une erreur est survenue');
          console.error('Error:', error);
        });
      }
    });
  });
  
  // Handle the self-assignment button
  document.querySelector('[href="#assign-to-me"]')?.addEventListener('click', function(e) {
    e.preventDefault();
    
    // Show loading state
    this.classList.add('loading');
    this.disabled = true;
    
    // Send assignment request to server
    fetch(`/incidents/{{ incident.id }}/assign/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Reload page to show updated assignment
        window.location.reload();
      } else {
        toast.error(data.message || 'Erreur lors de l\'assignation');
        this.classList.remove('loading');
        this.disabled = false;
      }
    })
    .catch(error => {
      toast.error('Une erreur est survenue');
      console.error('Error:', error);
      this.classList.remove('loading');
      this.disabled = false;
    });
  });
  
  // Helper to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // Show success message if redirected with query param
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('assignment_success') === 'true') {
      toast.success('Incident assigné avec succès');
      
      // Remove query param from URL without reloading page
      const newUrl = window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
    }
  });
</script>
{% endblock %}