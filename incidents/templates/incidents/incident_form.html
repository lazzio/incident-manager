{% extends "incidents/base.html" %}

{% block title %}
    {% if incident %}Edit Incident{% else %}New Incident{% endif %} | Tech Incident Manager
{% endblock %}

{% block extra_css %}
<style>
    .formset-item {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
    }
    
    .delete-row {
        color: #dc3545;
        cursor: pointer;
    }
    
    .add-row {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{% if incident %}Edit Incident{% else %}New Incident{% endif %}</h1>
            <a href="{% url 'incident_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Incident Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date</label>
                            {{ form.start_date }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date</label>
                            {{ form.end_date }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.details.id_for_label }}" class="form-label">Details</label>
                            {{ form.details }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.impact.id_for_label }}" class="form-label">Impact</label>
                            {{ form.impact }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.resolution_process.id_for_label }}" class="form-label">Resolution Process</label>
                            {{ form.resolution_process }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Attachments</h5>
                    <button type="button" class="btn btn-sm btn-success add-row" data-formset="attachments">
                        <i class="fas fa-plus"></i> Add Attachment
                    </button>
                </div>
                <div class="card-body">
                    {{ attachment_formset.management_form }}
                    <div id="attachments-container">
                        {% for form in attachment_formset.forms %}
                        <div class="formset-item attachments-form">
                            {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.file.id_for_label }}" class="form-label">File</label>
                                    {{ form.file }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                                    {{ form.description }}
                                    {% if form.instance.pk %}
                                    <div class="mt-2">
                                        <a href="{{ form.instance.file.url }}" target="_blank">
                                            {{ form.instance.file.name }}
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% if form.instance.pk %}
                            <div class="text-end">
                                <label class="form-check-label">
                                    <input type="checkbox" name="{{ form.DELETE.html_name }}" id="{{ form.DELETE.id_for_label }}" class="form-check-input">
                                    Delete this attachment
                                </label>
                            </div>
                            {% else %}
                            <div class="text-end">
                                <a href="#" class="delete-row text-danger" data-formset="attachments">
                                    <i class="fas fa-trash"></i> Remove
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div id="empty-attachment-form" style="display: none;">
                        <div class="formset-item attachments-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">File</label>
                                    {{ attachment_formset.empty_form.file }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Description</label>
                                    {{ attachment_formset.empty_form.description }}
                                </div>
                            </div>
                            <div class="text-end">
                                <a href="#" class="delete-row text-danger" data-formset="attachments">
                                    <i class="fas fa-trash"></i> Remove
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Links</h5>
                    <button type="button" class="btn btn-sm btn-success add-row" data-formset="links">
                        <i class="fas fa-plus"></i> Add Link
                    </button>
                </div>
                <div class="card-body">
                    {{ link_formset.management_form }}
                    <div id="links-container">
                        {% for form in link_formset.forms %}
                        <div class="formset-item links-form">
                            {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.url.id_for_label }}" class="form-label">URL</label>
                                    {{ form.url }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
                                    {{ form.title }}
                                </div>
                            </div>
                            {% if form.instance.pk %}
                            <div class="text-end">
                                <label class="form-check-label">
                                    <input type="checkbox" name="{{ form.DELETE.html_name }}" id="{{ form.DELETE.id_for_label }}" class="form-check-input">
                                    Delete this link
                                </label>
                            </div>
                            {% else %}
                            <div class="text-end">
                                <a href="#" class="delete-row text-danger" data-formset="links">
                                    <i class="fas fa-trash"></i> Remove
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div id="empty-link-form" style="display: none;">
                        <div class="formset-item links-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">URL</label>
                                    {{ link_formset.empty_form.url }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Title</label>
                                    {{ link_formset.empty_form.title }}
                                </div>
                            </div>
                            <div class="text-end">
                                <a href="#" class="delete-row text-danger" data-formset="links">
                                    <i class="fas fa-trash"></i> Remove
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{% url 'incident_list' %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    {% if incident %}Update{% else %}Create{% endif %} Incident
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Add Django form classes
        $('input[type="text"], input[type="url"], input[type="file"], textarea, select').addClass('form-control');
        
        // Handle formset addition
        $('.add-row').click(function() {
            var formsetName = $(this).data('formset');
            var container = $('#' + formsetName + '-container');
            var totalForms = $('#id_' + formsetName + '-TOTAL_FORMS');
            var newForm = $('#empty-' + formsetName + '-form').html();
            var formNum = parseInt(totalForms.val());
            
            newForm = newForm.replace(/__prefix__/g, formNum);
            container.append(newForm);
            totalForms.val(formNum + 1);
            
            // Re-add form classes to new form
            $('.form-control').addClass('form-control');
        });
        
        // Handle formset deletion
        $(document).on('click', '.delete-row', function(e) {
            e.preventDefault();
            $(this).closest('.formset-item').remove();
        });
    });
</script>
{% endblock %}